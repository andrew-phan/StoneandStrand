define(['jquery','underscore','jquery/ui'],function($,_){'use strict';$.parseParams=function(query){var re=/([^&=]+)=?([^&]*)/g,decodeRE=/\+/g,decode=function(str){return decodeURIComponent(str.replace(decodeRE," "));},params={},e;while(e=re.exec(query)){var k=decode(e[1]),v=decode(e[2]);if(k.substring(k.length-2)==='[]'){k=k.substring(0,k.length-2);(params[k]||(params[k]=[])).push(v);}
else params[k]=v;}
return params;};$.widget('custom.SwatchRendererTooltip',{options:{delay:200,tooltip_class:'swatch-option-tooltip'},_init:function(){var $widget=this,$this=this.element,$element=$('.'+$widget.options.tooltip_class),timer,type=parseInt($this.attr('option-type'),10),label=$this.attr('option-label'),thumb=$this.attr('option-tooltip-thumb'),value=$this.attr('option-tooltip-value');if($element.size()==0){$element=$('<div class="'+$widget.options.tooltip_class+'"><div class="image"></div><div class="title"></div><div class="corner"></div></div>');$('body').append($element);}
var $image=$element.find('.image'),$title=$element.find('.title'),$corner=$element.find('.corner');$this.hover(function(){if(!$this.hasClass('disabled')){timer=setTimeout(function(){if(type==2){$image.css({'background':'url("'+thumb+'") no-repeat center','background-size':'initial'});$image.show();}
else if(type==1){$image.css({background:value});$image.show();}
else if(type==0||type==3){$image.hide();}
$title.text(label);var leftOpt=$this.offset().left,left=leftOpt+($this.width()/ 2)-($element.width()/ 2),$window=$(window);if(left<0){left=5;}else if(left+$element.width()>$window.width()){left=$window.width()-$element.width()-5;}
var leftCorner=0;if($element.width()<$this.width()){leftCorner=$element.width()/ 2-3;}else{leftCorner=(leftOpt>left?leftOpt-left:left-leftOpt)+($this.width()/ 2)-6;}
$corner.css({left:leftCorner});$element.css({left:left,top:$this.offset().top-$element.height()-$corner.height()-18}).show();},$widget.options.delay);}},function(){$element.hide();clearTimeout(timer);});$(document).on('tap',function(){$element.hide();clearTimeout(timer);});$this.on('tap',function(event){event.stopPropagation();});}});$.widget('custom.SwatchRenderer',{options:{classes:{attributeClass:'swatch-attribute',attributeLabelClass:'swatch-attribute-label',attributeSelectedOptionLabelClass:'swatch-attribute-selected-option',attributeOptionsWrapper:'swatch-attribute-options',attributeInput:'swatch-input',optionClass:'swatch-option',selectClass:'swatch-select',moreButton:'swatch-more',loader:'swatch-option-loading'},jsonConfig:{},jsonSwatchConfig:{},selectorProduct:'.product-info-main',selectorProductPrice:'[data-role=priceBox]',numberToShow:false,onlySwatches:false,enableControlLabel:true,moreButtonText:'More',mediaCallback:'',mediaGalleryInitial:[{}]},getProduct:function(){return this._CalcProducts().shift();},_init:function(){if(this.options.jsonConfig!=''&&this.options.jsonSwatchConfig!=''){this._RenderControls();}else{console.log('SwatchRenderer: No input data received');}},_create:function(){var options=this.options,gallery=$('[data-gallery-role=gallery-placeholder]','.column.main'),isProductViewExist=$('body.catalog-product-view').size()>0,$main=isProductViewExist?this.element.parents('.column.main'):this.element.parents('.product-item-info');if(isProductViewExist){gallery.on('gallery:loaded',function(){var galleryObject=gallery.data('gallery');options.mediaGalleryInitial=galleryObject.returnCurrentImages();});}else{options.mediaGalleryInitial=[{'img':$main.find('.product-image-photo').attr('src')}];}},_RenderControls:function(){var $widget=this,container=this.element,classes=this.options.classes,chooseText=this.options.jsonConfig.chooseText;$widget.optionsMap={};$.each(this.options.jsonConfig.attributes,function(){var item=this,options=$widget._RenderSwatchOptions(item),select=$widget._RenderSwatchSelect(item,chooseText),input=$widget._RenderFormInput(item),label='';if($widget.options.onlySwatches&&!$widget.options.jsonSwatchConfig.hasOwnProperty(item.id)){return;}
if($widget.options.enableControlLabel){label+='<span class="'+classes.attributeLabelClass+'">'+item.label+'</span>'+'<span class="'+classes.attributeSelectedOptionLabelClass+'"></span>';}
container.append('<div class="'+classes.attributeClass+' '+item.code+'" attribute-code="'+item.code+'" attribute-id="'+item.id+'">'+label+'<div class="'+classes.attributeOptionsWrapper+' clearfix">'+options+select+'</div>'+input+'</div>');$widget.optionsMap[item.id]={};$.each(item.options,function(){if(this.products.length>0){$widget.optionsMap[item.id][this.id]={price:parseInt($widget.options.jsonConfig.optionPrices[this.products[0]].finalPrice.amount,10),products:this.products};}});});container.find('[option-type="1"], [option-type="2"], [option-type="0"], [option-type="3"]').SwatchRendererTooltip();$('.'+classes.moreButton).nextAll().hide();$widget._EventListener();$widget._Rewind(container);$widget._EmulateSelected();},_RenderSwatchOptions:function(config){if(!this.options.jsonSwatchConfig.hasOwnProperty(config.id)){return'';}
var optionConfig=this.options.jsonSwatchConfig[config.id],optionClass=this.options.classes.optionClass,moreLimit=this.options.numberToShow,moreClass=this.options.classes.moreButton,moreText=this.options.moreButtonText,countAttributes=0,html='';$.each(config.options,function(){if(!optionConfig.hasOwnProperty(this.id)){return'';}
if(moreLimit!=false&&moreLimit==countAttributes++){html+='<a href="#" class="'+moreClass+'">'+moreText+'</a>';}
var id=this.id,type=optionConfig[id].type,value=optionConfig[id].hasOwnProperty('value')?optionConfig[id].value:'',thumb=optionConfig[id].hasOwnProperty('thumb')?optionConfig[id].thumb:'',label=this.label?this.label:'',attr=' option-type="'+type+'"'+' option-id="'+id+'"'+' option-label="'+label+'"'+' option-tooltip-thumb="'+thumb+'"'+' option-tooltip-value="'+value+'"';if(!this.hasOwnProperty('products')||this.products.length<=0){attr+=' option-empty="true"';}
if(type==0){html+='<div class="'+optionClass+' text" '+attr+'>'+(value?value:label)+'</div>';}
else if(type==1){html+='<div class="'+optionClass+' color" '+attr+'" style="background: '+value+' no-repeat center; background-size: initial;">'+''+'</div>';}
else if(type==2){html+='<div class="'+optionClass+' image" '+attr+'" style="background: url('+value+') no-repeat center; background-size: initial;">'+''+'</div>';}
else if(type==3){html+='<div class="'+optionClass+'" '+attr+'></div>';}
else{html+='<div class="'+optionClass+'" '+attr+'>'+label+'</div>';}});return html;},_RenderSwatchSelect:function(config,chooseText){if(this.options.jsonSwatchConfig.hasOwnProperty(config.id)){return'';}
var html='<select class="'+this.options.classes.selectClass+' '+config.code+'">'+'<option value="0" option-id="0">'+chooseText+'</option>';$.each(config.options,function(){var label=this.label,attr=' value="'+this.id+'" option-id="'+this.id+'"';if(!this.hasOwnProperty('products')||this.products.length<=0){attr+=' option-empty="true"';}
html+='<option '+attr+'>'+label+'</option>';});html+='</select>';return html;},_RenderFormInput:function(config){return'<input class="'+this.options.classes.attributeInput+'" '+'name="super_attribute['+config.id+']" '+'value="" '+'data-validate="{required:true}" '+'aria-required="true" '+'aria-invalid="true" '+'style="visibility: hidden; position:absolute; left:-1000px">';},_EventListener:function(){var $widget=this;$widget.element.on('click','.'+this.options.classes.optionClass,function(){return $widget._OnClick($(this),$widget);});$widget.element.on('change','.'+this.options.classes.selectClass,function(){return $widget._OnChange($(this),$widget);});$widget.element.on('click','.'+this.options.classes.moreButton,function(e){e.preventDefault();return $widget._OnMoreClick($(this));});},_OnClick:function($this,$widget){var $parent=$this.parents('.'+$widget.options.classes.attributeClass),$label=$parent.find('.'+$widget.options.classes.attributeSelectedOptionLabelClass),$input=$parent.find('.'+$widget.options.classes.attributeInput);if($this.hasClass('disabled')){return;}
if($this.hasClass('selected')){$parent.removeAttr('option-selected').find('.selected').removeClass('selected');$input.val('');$label.text('');}else{$parent.attr('option-selected',$this.attr('option-id')).find('.selected').removeClass('selected');$label.text($this.attr('option-label'));$input.val($this.attr('option-id'));$this.addClass('selected');}
$widget._Rebuild();if($widget.element.parents($widget.options.selectorProduct).find(this.options.selectorProductPrice).is(':data(mage-priceBox)')){$widget._UpdatePrice();}
$widget._LoadProductMedia();},_OnChange:function($this,$widget){var $parent=$this.parents('.'+$widget.options.classes.attributeClass),$input=$parent.find('.'+$widget.options.classes.attributeInput);if($this.val()>0){$parent.attr('option-selected',$this.val());$input.val($this.val());}else{$parent.removeAttr('option-selected');$input.val('');}
$widget._Rebuild();$widget._UpdatePrice();$widget._LoadProductMedia();},_OnMoreClick:function($this){$this.nextAll().show();$this.blur().remove();},_Rewind:function(controls){controls.find('div[option-id], option[option-id]').removeClass('disabled').removeAttr('disabled');controls.find('div[option-empty], option[option-empty]').attr('disabled',true).addClass('disabled');},_Rebuild:function(){var $widget=this,controls=$widget.element.find('.'+$widget.options.classes.attributeClass+'[attribute-id]'),selected=controls.filter('[option-selected]');$widget._Rewind(controls);if(selected.size()<=0){return;}
controls.each(function(){var $this=$(this),id=$this.attr('attribute-id'),products=$widget._CalcProducts(id);if(selected.size()==1&&selected.first().attr('attribute-id')==id){return;}
$this.find('[option-id]').each(function(){var $this=$(this),option=$this.attr('option-id');if(!$widget.optionsMap.hasOwnProperty(id)||!$widget.optionsMap[id].hasOwnProperty(option)||$this.hasClass('selected')||$this.is(':selected')){return;}
if(_.intersection(products,$widget.optionsMap[id][option].products).length<=0){$this.attr('disabled',true).addClass('disabled');}});});},_CalcProducts:function($skipAttributeId){var $widget=this,products=[];$widget.element.find('.'+$widget.options.classes.attributeClass+'[option-selected]').each(function(){var id=$(this).attr('attribute-id');var option=$(this).attr('option-selected');if($skipAttributeId!=undefined&&$skipAttributeId==id){return;}
if(!$widget.optionsMap.hasOwnProperty(id)||!$widget.optionsMap[id].hasOwnProperty(option)){return;}
if(products.length==0){products=$widget.optionsMap[id][option].products;}else{products=_.intersection(products,$widget.optionsMap[id][option].products);}});return products;},_UpdatePrice:function(){var $widget=this,$product=$widget.element.parents($widget.options.selectorProduct),$productPrice=$product.find(this.options.selectorProductPrice),options=_.object(_.keys($widget.optionsMap),{}),result;$widget.element.find('.'+$widget.options.classes.attributeClass+'[option-selected]').each(function(){var attributeId=$(this).attr('attribute-id'),selectedOptionId=$(this).attr('option-selected');options[attributeId]=selectedOptionId;});result=$widget.options.jsonConfig.optionPrices[_.findKey($widget.options.jsonConfig.index,options)];$productPrice.trigger('updatePrice',{'prices':$widget._getPrices(result,$productPrice.priceBox('option').prices)});},_getPrices:function(newPrices,displayPrices){var $widget=this;if(_.isEmpty(newPrices)){newPrices=$widget.options.jsonConfig.prices;}
_.each(displayPrices,function(price,code){if(newPrices[code]){displayPrices[code].amount=newPrices[code].amount-displayPrices[code].amount;}});return displayPrices;},_LoadProductMedia:function(){var $widget=this,$this=$widget.element,attributes={},productId=0;if(!$widget.options.mediaCallback){return;}
$this.find('[option-selected]').each(function(){var $selected=$(this);attributes[$selected.attr('attribute-code')]=$selected.attr('option-selected');});if($('body.catalog-product-view').size()>0){productId=document.getElementsByName('product')[0].value;}else{productId=$this.parents('.product.details.product-item-details').find('.price-box.price-final_price').attr('data-product-id');}
var additional=$.parseParams(window.location.search.substring(1));$widget._XhrKiller();$widget._EnableProductMediaLoader($this);$widget.xhr=$.post($widget.options.mediaCallback,{product_id:productId,attributes:attributes,isAjax:true,additional:additional},function(data){$widget._ProductMediaCallback($this,data);$widget._DisableProductMediaLoader($this);},'json').done(function(){$widget._XhrKiller();});},_EnableProductMediaLoader:function($this){var $widget=this;if($('body.catalog-product-view').size()>0){$this.parents('.column.main').find('.photo.image').addClass($widget.options.classes.loader);}else{$this.parents('.product-item-info').find('.product-image-photo').addClass($widget.options.classes.loader);}},_DisableProductMediaLoader:function($this){var $widget=this;if($('body.catalog-product-view').size()>0){$this.parents('.column.main').find('.photo.image').removeClass($widget.options.classes.loader);}else{$this.parents('.product-item-info').find('.product-image-photo').removeClass($widget.options.classes.loader);}},_ProductMediaCallback:function($this,response){var isProductViewExist=$('body.catalog-product-view').size()>0,$main=isProductViewExist?$this.parents('.column.main'):$this.parents('.product-item-info'),$widget=this,images=[],support=function(e){return e.hasOwnProperty('large')&&e.hasOwnProperty('medium')&&e.hasOwnProperty('small');};if($widget._ObjectLength(response)<1){this.updateBaseImage(this.options.mediaGalleryInitial,$main,isProductViewExist);return;}
if(support(response)){images.push({full:response.large,img:response.medium,thumb:response.small});if(response.hasOwnProperty('gallery')){$.each(response.gallery,function(){if(!support(this)||response.large===this.large){return;}
images.push({full:this.large,img:this.medium,thumb:this.small});});}}
this.updateBaseImage(images,$main,isProductViewExist);},updateBaseImage:function(images,context,isProductViewExist){var justAnImage=images[0];if(isProductViewExist){context.find('[data-gallery-role=gallery-placeholder]').data('gallery').updateData(images);}else if(justAnImage&&justAnImage.img){context.find('.product-image-photo').attr('src',justAnImage.img);}},_XhrKiller:function(){var $widget=this;if($widget.xhr!==undefined&&$widget.xhr!==null){$widget.xhr.abort();$widget.xhr=null;}},_EmulateSelected:function(){var $widget=this,$this=$widget.element,request=$.parseParams(window.location.search.substring(1));$.each(request,function(key,value){$this.find('.'+$widget.options.classes.attributeClass
+'[attribute-code="'+key+'"] [option-id="'+value+'"]').trigger('click');});},_ObjectLength:function(obj){var size=0,key;for(key in obj){if(obj.hasOwnProperty(key))size++;}
return size;}});});